@model InteliRoute.Models.ViewModels.SuperAdminIndexVm
@{
    ViewData["Title"] = "Super Admin";
}

<style>
  .card-eq .card { height: 100%; }
  .section-title { font-weight: 600; }
  .table-actions { white-space: nowrap; }
  .modal .form-label { font-weight: 500; }
</style>

<div class="container py-4">
  <h2 class="mb-3">Super Admin</h2>

  @if (TempData["ok"] is string ok) { <div class="alert alert-success">@ok</div> }
  @if (TempData["err"] is string err) { <div class="alert alert-danger">@err</div> }

  <!-- Row 1: Add Tenant / Tenant Details -->
  <div class="row g-4 card-eq">
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header section-title">Add Tenant</div>
        <div class="card-body">
          <form asp-action="CreateTenant" method="post" class="row g-3">
            @Html.AntiForgeryToken()
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input asp-for="NewTenant.Name" class="form-control"/>
              <span asp-validation-for="NewTenant.Name" class="text-danger"></span>
            </div>
            <div class="col-md-6">
              <label class="form-label">Domains (CSV)</label>
              <input asp-for="NewTenant.DomainsCsv" class="form-control" placeholder="acme.com, contoso.com"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Active?</label>
              <select asp-for="NewTenant.IsActive" class="form-select">
                <option value="true">Yes</option><option value="false">No</option>
              </select>
            </div>
            <div class="col-12 text-end">
              <button type="submit" class="btn btn-primary">Add Tenant</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header section-title">Tenant Details</div>
        <div class="card-body">
          @if (Model.SelectedTenantId is null || Model.EditTenant is null)
          {
            <div class="text-muted">Select a tenant on the left to view and edit details.</div>
          }
          else
          {
            <form asp-action="UpdateTenant" method="post" class="row g-3">
              @Html.AntiForgeryToken()
              <input type="hidden" asp-for="EditTenant!.Id"/>
              <div class="col-md-6">
                <label class="form-label">Name</label>
                <input asp-for="EditTenant!.Name" class="form-control"/>
                <span asp-validation-for="EditTenant!.Name" class="text-danger"></span>
              </div>
              <div class="col-md-6">
                <label class="form-label">Domains (CSV)</label>
                <input asp-for="EditTenant!.DomainsCsv" class="form-control"/>
              </div>
              <div class="col-md-6">
                <label class="form-label">Active?</label>
                <select asp-for="EditTenant!.IsActive" class="form-select">
                  <option value="true">Yes</option><option value="false">No</option>
                </select>
              </div>
              <div class="col-12 text-end">
                <button class="btn btn-secondary">Save Tenant</button>
              </div>
            </form>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Row 2: Tenants / Add Tenant Admin -->
  <div class="row g-4 mt-1 card-eq">
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header section-title">Tenants</div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-striped mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width:22%">Name</th>
                  <th>Domains</th>
                  <th style="width:12%">Status</th>
                  <th style="width:20%" class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
              @if (Model.Tenants.Any())
              {
                foreach (var t in Model.Tenants)
                {
                  var selected = Model.SelectedTenantId == t.Id;
                  <tr class="@(selected ? "table-primary" : "")">
                    <td>@t.Name</td>
                    <td class="text-muted">@t.DomainsCsv</td>
                    <td>
                      @if (t.IsActive) { <span class="badge bg-success">Active</span> }
                      else { <span class="badge bg-secondary">Disabled</span> }
                    </td>
                    <td class="text-end table-actions">
                      <form asp-action="SelectTenant" method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@t.Id"/>
                        <button class="btn btn-sm btn-outline-primary">Open</button>
                      </form>
                      <form asp-action="ToggleTenantActive" method="post" class="d-inline ms-1">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@t.Id"/>
                        <input type="hidden" name="enable" value="@(t.IsActive ? "false" : "true")"/>
                        @if (t.IsActive)
                          { <button class="btn btn-sm btn-outline-danger">Disable</button> }
                        else
                          { <button class="btn btn-sm btn-outline-success">Enable</button> }
                      </form>
                    </td>
                  </tr>
                }
              }
              else
              {
                <tr><td colspan="4" class="text-center text-muted">No tenants yet.</td></tr>
              }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header section-title">Add Tenant Admin</div>
        <div class="card-body">
          @if (Model.SelectedTenantId is null)
          {
            <div class="text-muted">Select a tenant to add admins.</div>
          }
          else
          {
            <form asp-action="CreateTenantAdmin" method="post" class="row g-3">
              @Html.AntiForgeryToken()
              <input type="hidden" asp-for="NewAdmin.TenantId"/>
              <div class="col-md-6">
                <label class="form-label">Username</label>
                <input asp-for="NewAdmin.Username" class="form-control"/>
                <span asp-validation-for="NewAdmin.Username" class="text-danger"></span>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input asp-for="NewAdmin.Email" class="form-control"/>
                <span asp-validation-for="NewAdmin.Email" class="text-danger"></span>
              </div>
              <div class="col-md-6">
                <label class="form-label">Password</label>
                <input asp-for="NewAdmin.Password" type="password" class="form-control"/>
                <span asp-validation-for="NewAdmin.Password" class="text-danger"></span>
              </div>
              <div class="col-md-3">
                <label class="form-label">Role</label>
                <input asp-for="NewAdmin.Role" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Active?</label>
                <select asp-for="NewAdmin.IsActive" class="form-select">
                  <option value="true">Yes</option><option value="false">No</option>
                </select>
              </div>
              <div class="col-12 text-end">
                <button class="btn btn-primary">Add Admin</button>
              </div>
            </form>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Row 3: Admins (full width) -->
  <div class="row g-4 mt-1">
    <div class="col-12">
      <div class="card">
        <div class="card-header section-title">Admins</div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-striped mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>Username</th>
                  <th>Email</th>
                  <th style="width:14%">Role</th>
                  <th style="width:10%">Status</th>
                  <th style="width:28%" class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
              @if (Model.SelectedTenantId is null || !Model.TenantAdmins.Any())
              {
                <tr><td colspan="5" class="text-center text-muted">No admins to show.</td></tr>
              }
              else
              {
                foreach (var a in Model.TenantAdmins)
                {
                  <tr>
                    <td>@a.Username</td>
                    <td class="text-muted">@a.Email</td>
                    <td>@a.Role</td>
                    <td>
                      @if (a.IsActive) { <span class="badge bg-success">Active</span> }
                      else { <span class="badge bg-secondary">Disabled</span> }
                    </td>
                    <td class="text-end table-actions">
                      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editAdmin-@a.Id">Edit</button>

                      <form asp-action="ToggleAdminActive" method="post" class="d-inline ms-1">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@a.Id"/>
                        <input type="hidden" name="tenantId" value="@Model.SelectedTenantId"/>
                        <input type="hidden" name="enable" value="@(a.IsActive ? "false" : "true")"/>
                        @if (a.IsActive) { <button class="btn btn-sm btn-outline-danger">Disable</button> }
                        else { <button class="btn btn-sm btn-outline-success">Enable</button> }
                      </form>

                      <form asp-action="ResetAdminPassword" method="post" class="d-inline ms-1">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="Id" value="@a.Id"/>
                        <input type="hidden" name="TenantId" value="@Model.SelectedTenantId"/>
                        <input name="NewPassword" type="password" class="form-control form-control-sm d-inline-block" style="width: 180px;" placeholder="New password"/>
                        <button class="btn btn-sm btn-outline-primary ms-1">Reset</button>
                      </form>
                    </td>
                  </tr>

                  <!-- Edit Admin Modal -->
                  <div class="modal fade" id="editAdmin-@a.Id" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Edit Admin</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form asp-action="UpdateTenantAdmin" method="post" class="modal-body row g-3">
                          @Html.AntiForgeryToken()
                          <input type="hidden" name="Id" value="@a.Id"/>
                          <input type="hidden" name="TenantId" value="@Model.SelectedTenantId"/>

                          <div class="col-md-6">
                            <label class="form-label">Username</label>
                            <input name="Username" value="@a.Username" class="form-control" required />
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input name="Email" type="email" value="@a.Email" class="form-control" required />
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Role</label>
                            <input name="Role" value="@a.Role" class="form-control" />
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Active?</label>
                                <select name="IsActive" class="form-select">
                                   @if (a.IsActive)
                                   {
                                  <option value="true" selected>Yes</option>
                                  <option value="false">No</option>
                                   }
                                   else
                                   {
                                  <option value="true">Yes</option>
                                  <option value="false" selected>No</option>
                                }
                               </select>                
                          </div>

                          <div class="modal-footer">
                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                }
              }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
  <partial name="_ValidationScriptsPartial" />
}
